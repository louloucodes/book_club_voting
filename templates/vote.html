{% extends "base.html" %}

{% block title %}Vote for a Book{% endblock %}

{% block content %}
    <h1>Book Club Monthly Vote</h1>

    {# Check which voting system is active and render the appropriate UI #}
    {% if voting_system == 'ranked_choice' %}
        <p class="instructions">
            Rank the books by dragging and dropping them into your preferred order. Your first choice should be at the top.
        </p>
        
        {# This list will be made sortable by SortableJS #}
        <ul id="ranked-choice-list" class="ranked-list">
            {% for book in books %}
                <li class="book-item" data-id="{{ book.id }}">
                    <span class="drag-handle">&#x2630;</span>
                    <div class="book-cover">
                        {% if book.cover_image_url %}
                            <img src="{{ book.cover_image_url }}" alt="Cover of {{ book.title }}">
                        {% else %}
                            <div class="cover-placeholder">No Image</div>
                        {% endif %}
                    </div>
                    <div class="book-info">
                        <h2 class="book-title">{{ book.title }}</h2>
                        <p class="book-author">by {{ book.author }}</p>
                        <p class="book-publication-date">Published: {{ book.published_date }}</p>
                        {% if book.page_count %}
                            <p class="book-page-count">{{ book.page_count }} pages</p>
                        {% endif %}
                    </div>
                    {% if config.SHOW_SUGGESTER %}
                    <div class="book-suggester">
                        <p>Suggested by:</p>
                        <strong>{{ book.suggested_by }}</strong>
                    </div>
                    {% endif %}

                    <!-- NEW: Add the summary dropdown, same as in the plurality view -->
                    {% if book.summary %}
                    <div class="book-summary">
                        <details>
                            <summary>Show Summary</summary>
                            <p>{{ book.summary }}</p>
                        </details>
                    </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
        <div class="controls">
            <!-- MODIFIED: Changed class to 'submit-button' for green color -->
            <button id="submit-ballot-button" class="submit-button">Submit Ballot</button>
        </div>
        <div id="vote-message" class="form-message"></div>
    {% elif voting_system == 'cumulative' %}
        <p class="instructions">
            Distribute {{ points_per_voter }} points among the books. You can give all points to one book or split them as you wish.
        </p>
        <form id="cumulative-vote-form" data-points-per-voter="{{ points_per_voter }}">
            <ul id="cumulative-list" class="cumulative-list">
                {% for book in books %}
                <li class="book-item" data-id="{{ book.id }}">
                    <div class="book-info">
                        <h2 class="book-title">{{ book.title }}</h2>
                        <p class="book-author">by {{ book.author }}</p>
                        {% if book.page_count %}
                            <p class="book-page-count">{{ book.page_count }} pages</p>
                        {% endif %}
                    </div>
                    <div class="cumulative-input">
                        <label for="points-{{ book.id }}">Points:</label>
                        <input type="number" id="points-{{ book.id }}" name="points-{{ book.id }}" min="0" max="{{ points_per_voter }}" value="0" class="points-input">
                    </div>
                </li>
                {% endfor %}
            </ul>
            <div class="controls">
                <span id="points-remaining">Points remaining: {{ points_per_voter }}</span>
                <button type="submit" id="submit-cumulative-ballot" class="submit-button">Submit Ballot</button>
            </div>
            <div id="vote-message" class="form-message"></div>
        </form>
    {% else %} {# Default to plurality voting system #}
        <p class="instructions">
            Welcome! Please vote for the book you would like to read next month.
        </p>

        <div id="book-list">
            {% for book in books %}
            <div class="book-item" id="book-item-{{ book.id }}">
                <div class="book-main-content">
                    <div class="book-cover">
                        {% if book.cover_image_url %}
                            <img src="{{ book.cover_image_url }}" alt="Cover of {{ book.title }}">
                        {% else %}
                            <div class="cover-placeholder">No Image</div>
                        {% endif %}
                    </div>
                    <div class="book-details">
                        <div class="book-info">
                            <h2 class="book-title">{{ book.title }}</h2>
                            <p class="book-author">by {{ book.author }}</p>
                            <p class="book-publication-date">Published: {{ book.published_date }}</p>
                            {% if book.page_count %}
                                <p class="book-page-count">{{ book.page_count }} pages</p>
                            {% endif %}
                            {% if config.SHOW_SUGGESTER %}
                                <p class="book-suggester-plurality">Suggested by: {{ book.suggested_by }}</p>
                            {% endif %}
                        </div>
                        <div class="vote-section">
                            <button class="vote-button" data-id="{{ book.id }}">Vote</button>
                            
                        </div>
                    </div>
                </div>
                {% if book.summary %}
                <div class="book-summary">
                    <details>
                        <summary>Show Summary</summary>
                        <p>{{ book.summary }}</p>
                    </details>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="controls">
        <!-- MODIFIED: Changed class to 'secondary-button' for blue styling -->
        <button id="export-button" class="secondary-button">Export Results</button>
    </div>
{% endblock %}

{% block scripts %}
    <!-- MODIFIED: Load main.js as a module. It will import SortableJS if needed. -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}