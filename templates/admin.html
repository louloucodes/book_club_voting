{% extends "base.html" %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
    <h1>Admin Panel</h1>

    <!-- NEW: Tab navigation structure -->
    <div class="tab-container">
        <button class="tab-link active" data-target="add-book-panel">Add New Book</button>
        <button class="tab-link" data-target="manage-books-panel">Manage Existing Books</button>
        <button class="tab-link" data-target="settings-panel">Settings</button>
    </div>

    <!-- NEW: Tab content panels -->

    <!-- Panel 1: Add Book -->
    <div id="add-book-panel" class="tab-content active">
        <div class="admin-section">
            <h2>Add a New Book</h2>
            <form id="add-book-form" method="POST" action="{{ url_for('admin.add_book') }}">
                <div class="form-group">
                    <label for="title">Book Title:</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" id="author" name="author" required>
                </div>
                <div class="form-group">
                    <label for="suggested_by">Suggested by</label>
                    <input type="text" id="suggested_by" name="suggested_by">
                </div>
                <button type="submit" class="submit-button">Add Book</button>
            </form>
            <div id="form-message" class="form-message"></div>
        </div>
    </div>

    <!-- Panel 2: Manage Books -->
    <div id="manage-books-panel" class="tab-content">
        <div class="admin-section">
            <h2>Manage Existing Books</h2>
            <p class="instructions">Drag and drop to reorder the books.</p>
            <ul id="manage-book-list">
                {% if books %} {# Fix 5: Ensure books variable exists #}
                {% for book in books %}
                <li class="book-item" data-id="{{ book.id }}" id="manage-item-{{ book.id }}">
                    <span class="drag-handle">&#x2630;</span>
                    <div class="book-cover">
                        {% if book.cover_image_url %}
                            <img src="{{ book.cover_image_url }}" alt="Cover of {{ book.title }}" width="50" height="75"> {# Fix 6: Add width/height #}
                        {% else %}
                            <div class="cover-placeholder">No Image</div>
                        {% endif %}
                    </div>
                    <div class="book-info">
                        <h2 class="book-title">{{ book.title }}</h2>
                        <p class="book-author">by {{ book.author }}</p>
                        <p class="book-publication-date">Published: {{ book.published_date }}</p>
                    </div>
                    {% if config.SHOW_SUGGESTER %}
                    <div class="book-suggester">
                        <p>Suggested by:</p>
                        <strong>{{ book.suggested_by }}</strong>
                    </div>
                    {% endif %}
                    <button class="delete-button" data-id="{{ book.id }}" aria-label="Delete book">&times;</button> {# Fix 7: Add aria-label #}
                </li>
                {% endfor %}
                {% endif %}
            </ul>
            <button id="save-order-button" class="submit-button" style="display: none;">Save New Order</button>
            <div id="order-message" class="form-message"></div>
        </div>
    </div>

    <!-- Panel 3: Settings -->
    <div id="settings-panel" class="tab-content">
        <div class="admin-section">
            <h2>Voting System Settings</h2>
            <form id="voting-system-form">
                <p>Current system: <strong>{{ config.VOTING_SYSTEM|replace('_', ' ')|title }}</strong></p>
                <div class="form-group">
                    <p class="form-label">Select a new voting system:</p> {# Fix 1: Use a <p> tag instead of a disconnected <label> #}
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="ranked_choice" name="voting_system" value="ranked_choice" {% if config.VOTING_SYSTEM == 'ranked_choice' %}checked{% endif %}>
                            <label for="ranked_choice">Ranked Choice</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="plurality" name="voting_system" value="plurality" {% if config.VOTING_SYSTEM == 'plurality' %}checked{% endif %}>
                            <label for="plurality">Plurality</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="cumulative" name="voting_system" value="cumulative" {% if config.VOTING_SYSTEM == 'cumulative' %}checked{% endif %}>
                            <label for="cumulative">Cumulative</label>
                        </div>
                    </div>
                </div>
                {# BETTER PRACTICE: Use a CSS class to control visibility instead of an inline style. #}
                <div class="form-group {% if config.VOTING_SYSTEM != 'cumulative' %}hidden{% endif %}" id="cumulative-points-group">
                    <label for="points_per_voter">Points per voter:</label>
                    <input type="number" id="points_per_voter" name="points_per_voter" min="1" value="{{ config.POINTS_PER_VOTER|default(5) }}">
                </div>
                <button type="submit" class="submit-button">Save Settings</button>
            </form>
            <div id="settings-message" class="form-message"></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }} {# This includes any scripts from base.html #}
    <script type="module" src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}